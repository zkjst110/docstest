

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>非共识节点介绍 &mdash; hyperchain  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> hyperchain
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">平台介绍:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">平台介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Version%20information.html">版本信息</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">快速入门:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../General%20Concepts.html">通用概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Prepare.html">准备工作</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Deployedfile.html">部署运维</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">基础协议:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../consensus%20mechanism.html">共识机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Networking%20protocol.html">网络协议</a></li>
<li class="toctree-l1"><a class="reference internal" href="../execution%20engine.html">执行引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Storage%20model.html">存储模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security%20mechanism.html">加密机制</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">扩展协议:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Architecture%20development.html">架构拓展</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Digital%20Service.html">数字服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Safe%20Privacy.html">隐私保护</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Governonce%20and%20audit.html">治理与审计</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Data%20management.html">数据管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Operation%20manage.html">运维管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Ecological%20components.html">区块链生态组件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../External%20Interface.html">外部接口</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">用户手册:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Chain%20Authority%20Management.html">链级权限管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Node%20and%20zone%20management.html">节点及分区管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Consensus%20related%20user%20manual.html">共识相关使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cross%20domain%20network%20User%20Manual.html">跨域网络使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Data%20storage%20and%20management.html">数据存储使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Password%20related.html">密码学相关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Security%20Audit.html">安全审计</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Data%20Monitor.html">数据监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qulian%20blockchain%20browser.html">趣链区块链浏览器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VM%20Related%20User%20Manual.html">（用户）智能合约使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Module.html">（用户）组件库</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">应用场景:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../application.html">应用案例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NFT%20and%20contract%20writing.html">数字藏品合约编写</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">更多资源:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Community_Resources.html">社区与资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">hyperchain</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>非共识节点介绍</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/Node and zone management/NVP User Manual.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nvp-user-manual">
<span id="id1"></span><h1>非共识节点介绍<a class="headerlink" href="#nvp-user-manual" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>引言<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>编写目的<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>本文档用于向开发、运维人员介绍NVP功能和使用方式。</p>
<p>NVP（Non-Validate Peer）不参与共识，仅通过信任的VP来同步数据，并对外提供数据查询、交易转发上链等服务。NVP同一时刻只能连接一个VP，但可动态替换VP，VP可以连接多个NVP。</p>
</div>
<div class="section" id="id4">
<h3>连接方式<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>vp和nvp互相连接一共四种方式，分别是：</p>
<ol class="arabic simple">
<li><p>在vp的配置文件里增加nvp信息，启动后自动连接；</p></li>
<li><p>在nvp的配置文件里增加vp信息，启动后自动连接；</p></li>
<li><p>通过ipc命令，在vp上动态添加nvp；</p></li>
<li><p>通过ipc命令，在nvp上动态添加vp；</p></li>
</ol>
</div>
</div>
<div class="section" id="id5">
<h2>启动节点&amp;检查证书配置<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="section" id="vp">
<h3>VP节点部署<a class="headerlink" href="#vp" title="Permalink to this headline">¶</a></h3>
<p>可以参照部署文档，启动vp节点。</p>
</div>
<div class="section" id="nvp">
<h3>NVP节点部署<a class="headerlink" href="#nvp" title="Permalink to this headline">¶</a></h3>
<p>NVP与VP之间需要进行基于证书的身份认证：在双方进行网络连接时，VP需要验证NVP确实拥有自己为其签发的rcert证书，否则将无法正常通信。</p>
<p>基于VP网络CA模式选择的不同，证书的签发和部署也有两种不同的方式：</p>
</div>
</div>
<div class="section" id="canvp">
<h2>非分布式CA下NVP节点部署<a class="headerlink" href="#canvp" title="Permalink to this headline">¶</a></h2>
<p>在非分布式CA的场景下，需要配置nvp的 <strong>节点证书和根证书</strong> ：</p>
<ul class="simple">
<li><p>节点证书–NVP通过节点证书来指定要绑定的VP节点，节点证书由VP节点为其颁发。必须是NVP类型的节点证书（certgen生成）。</p></li>
<li><p>根证书–和绑定VP节点的根证书保持一致。目录下可以有多个CA，与VP节点的CA目录保持一致即可。</p></li>
</ul>
<p>NVP节点证书配置后的证书目录如下图所示，其中CA目录下存放的文件与VP节点CA目录中的文件相同，certs目录下存放了NVP自己的私钥和VP节点为NVP颁发的节点证书：</p>
<p><img alt="image0" src="../_images/nvp1.png" /></p>
<p><strong>注：</strong> 以上CA目录下包含了多个CA只是示例中的一种，主要体现为了与VP节点的CA目录保持一致，通常情况该目录下只包含一个CA。</p>
</div>
<div class="section" id="id6">
<h2>分布式CA下NVP节点部署<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>在分布式CA的场景下，NVP需要配置节点证书和根证书要求如下：</p>
<ul class="simple">
<li><p>节点证书–NVP通过节点证书来指定要绑定的VP节点，节点证书由VP节点为其颁发。必须是NVP类型的节点证书（由certgen生成）。</p></li>
<li><p>根证书–可以是独立的根证书，也可以与VP的根证书保持一致。目录下必须只能包含一个CA。</p></li>
</ul>
<p>节点证书配置目录如下图所示，这里CA目录下包含一个.ca文件（根证书），包含一个.priv文件（私钥文件）。certs目录下包含一个节点证书和一个私钥：</p>
<p><img alt="image1" src="../_images/nvp2.png" /></p>
<p>注：上图假设NVP节点配置了一个与其他VP节点不同的CA，因此叫做root5.ca，也可以与要绑定的VP节点其CA目录中的文件保持一致。</p>
<div class="section" id="id7">
<h3>NVP证书生成<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>对应生成证书的命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>certgen gk ./key.priv ./key.pub

certgen gc --cn node5 --nvp node1 --ct rcert --pub ./key.pub ./root1.ca ./root1.priv ./node5.cert
解释
--cn  后面参数代表本节点的hostname
--nvp 后面参数为NVP要绑定的VP节点的hostname
--ct  为证书类型，NVP为rcert，VP为ecert
--pub 后面跟需要申请证书节点的公钥的路径，可以是相对路径
./root1.ca   代表证书颁发者的根证书路径，可以是相对路径
./root1.priv 代表证书颁发者的根证书私钥路径，可以是相对路径
./node5.cert 代表要生成的证书的名称
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>节点连接<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>对于NVP节点来说，若其未连接任何VP节点，也能正常工作，但不能转发交易，不能同步新数据。当要与VP节点连接时，NVP节点需要提前准备和VP相连的证书文件，还需要进行相应的配置：</p>
<ol class="arabic simple">
<li><p>NVP作为独立节点启动，需要在NVP节点的 <cite>configuration/dynamic.toml</cite> 文件中 <strong>修改self节点名称、port端口、域配置。</strong></p></li>
</ol>
<ul class="simple">
<li><p>注意： <strong>NVP的配置信息不能和VP节点的配置信息重复</strong></p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>在NVP节点的 <cite>configuration/global/ns_dynamic.toml</cite> 文件 <strong>修改[self]信息，</strong> 具体的配置根据不同的连接方式略有不同，在下面详细介绍。</p></li>
<li><p>配置完成之后，可以通过 <cite>start.sh</cite> 脚本或 <cite>./hyperchain</cite> 来启动节点。由于VP和NVP可以动态地建立连接，因此无须同时启动。</p></li>
</ol>
<p>VP和NVP节点互相连接方式一共有四种，选择任意一种方式都可以完成NVP和VP的连接，下文将详细介绍每种连接方式。</p>
<div class="section" id="vpnvp">
<h3>在VP上配置NVP<a class="headerlink" href="#vpnvp" title="Permalink to this headline">¶</a></h3>
<p>如果要在VP启动时能够自动去连接指定的NVP，需要在VP节点的 <cite>configuration/global/ns_dynamic.toml</cite> 文件做相应修改。在四个VP节点启动并相互连接的场景下，增加两个与node1相连接的NVP需要修改的配置项如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="n">nvps</span><span class="p">]]</span>                               <span class="c1"># 运行时修改。nvps数组在节点运行过程中实时变化。</span>
<span class="n">hostname</span>       <span class="o">=</span> <span class="s2">&quot;nvp1&quot;</span>    <span class="c1"># nvp节点的名称</span>
<span class="n">score</span>       <span class="o">=</span> <span class="mi">10</span>        <span class="c1"># 默认为10，表示节点的优先级</span>

<span class="p">[[</span><span class="n">nvps</span><span class="p">]]</span>                               <span class="c1"># 运行时修改。nvps数组在节点运行过程中实时变化。</span>
<span class="n">hostname</span>       <span class="o">=</span> <span class="s2">&quot;nvp2&quot;</span>    <span class="c1"># nvp节点的名称</span>
<span class="n">score</span>       <span class="o">=</span> <span class="mi">10</span>        <span class="c1"># 默认为10，表示节点的优先级</span>

<span class="p">[</span><span class="n">p2p</span><span class="p">]</span>

 <span class="p">[</span><span class="n">p2p</span><span class="o">.</span><span class="n">ip</span><span class="p">]</span>

   <span class="p">[</span><span class="n">p2p</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">remote</span><span class="p">]</span>

     <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span>
               <span class="s2">&quot;node1 127.0.0.1:50011&quot;</span><span class="p">,</span>
               <span class="s2">&quot;node2 127.0.0.1:50012&quot;</span><span class="p">,</span>
               <span class="s2">&quot;node3 127.0.0.1:50013&quot;</span><span class="p">,</span>
               <span class="s2">&quot;node4 127.0.0.1:50014&quot;</span><span class="p">,</span>
               <span class="s2">&quot;nvp1 127.0.0.1:50215&quot;</span><span class="p">,</span>
               <span class="s2">&quot;nvp2 127.0.0.1:50216&quot;</span><span class="p">,</span>
               <span class="p">]</span>
</pre></div>
</div>
<p>由于NVP是namespace级别的节点，所以只需要增加nvp列表字段：</p>
<ul class="simple">
<li><p>[[nvps]]表示nvp数组，数组中记录有nvp的信息。</p></li>
<li><p>[p2p]的hosts列表中，增加nvp的节点名和地址信息字段。</p></li>
</ul>
<p>其他部分的内容无需修改，[self]中的n数量指的是连接的vp数量，无需变化。</p>
</div>
<div class="section" id="nvpvp">
<h3>在NVP上配置VP<a class="headerlink" href="#nvpvp" title="Permalink to this headline">¶</a></h3>
<p>同理，在NVP节点启动前需要指定连接的VP，先按照部署文档进行必要的地址端口修改，然后在NVP节点的 <cite>configuration/global/ns_dynamic.toml</cite> 文件做相应修改。 <strong>NVP只能连接一个VP</strong> ，需要修改的配置项如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="n">nodes</span><span class="p">]]</span>            <span class="c1"># 运行时修改。nodes数组记录vp节点信息</span>
                        <span class="c1"># 在节点运行过程中实时变化。</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;node1&quot;</span> <span class="c1"># vp节点的名称</span>
 <span class="n">score</span> <span class="o">=</span> <span class="mi">10</span>         <span class="c1">#节点的优先级，默认为10</span>

<span class="p">[</span><span class="n">p2p</span><span class="p">]</span>

 <span class="p">[</span><span class="n">p2p</span><span class="o">.</span><span class="n">ip</span><span class="p">]</span>

   <span class="p">[</span><span class="n">p2p</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">remote</span><span class="p">]</span>
               <span class="c1"># hosts里面需要配置nvp连接的vp的节点名称和ip地址</span>
     <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;node1 127.0.0.1:50011&quot;</span><span class="p">]</span>

<span class="p">[</span><span class="bp">self</span><span class="p">]</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;nvp1&quot;</span>  <span class="c1"># nvp节点的名称</span>
 <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>              <span class="c1"># 连接的vp数量(0或者1)</span>
 <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;nvp&quot;</span>       <span class="c1"># 节点类型</span>
</pre></div>
</div>
<ul class="simple">
<li><p>[[nodes]]字段，只添加与NVP节点连接的VP节点信息；</p></li>
<li><p>[p2p]字段，同时配置VP的节点名称和ip地址；</p></li>
<li><p>[self]字段，修改对应的NVP信息；</p>
<ul>
<li><p>hostname为NVP节点的名称；</p></li>
<li><p>n表示要连接的VP数量为1（NVP上n的数值&lt;=1)；</p></li>
<li><p>type字段用来记录节点的类型为NVP；</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ipc">
<h3>通过ipc命令新增<a class="headerlink" href="#ipc" title="Permalink to this headline">¶</a></h3>
<p>上述通过配置的方式需要进行节点的启停从而使配置生效，实际上也可以通过ipc命令动态地进行NVP的增删操作。</p>
<p>命令格式： <cite>nvp add &lt;namespace&gt; &lt;hostname&gt; &lt;address&gt;</cite> 。</p>
</div>
<div class="section" id="ipcvp">
<h3>通过ipc命令新增VP<a class="headerlink" href="#ipcvp" title="Permalink to this headline">¶</a></h3>
<p>在nvp上也可以通过命令动态地增删VP，这里不再赘述。</p>
</div>
</div>
<div class="section" id="id9">
<h2>IPC命令<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>平台提供查询NVP状态、新增NVP、删除NVP三类IPC运维命令。</p>
<ol class="arabic simple">
<li><p><cite>nvp status</cite> ：查询NVP的当前状态，在NVP和VP执行返回信息不同；</p></li>
<li><p><cite>nvp add</cite> ：在VP上执行为新增NVP，在NVP上执行为新增VP；</p></li>
<li><p><cite>nvp remove</cite> ：在VP上执行为删除NVP，在NVP上执行为删除VP。</p></li>
</ol>
<p>IPC命令格式如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nvp</span> <span class="n">add</span> <span class="o">&lt;</span><span class="n">namespace</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">hostname</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">addr</span><span class="o">&gt;</span>    <span class="o">//</span><span class="n">新增</span>
<span class="n">nvp</span> <span class="n">remove</span> <span class="o">&lt;</span><span class="n">namespace</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">hostname</span><span class="o">&gt;</span>        <span class="o">//</span><span class="n">删除</span>
<span class="n">nvp</span> <span class="n">status</span> <span class="o">&lt;</span><span class="n">nameapce</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">hostname</span><span class="p">]</span>         <span class="o">//</span><span class="n">状态查询</span>
</pre></div>
</div>
<p>调用IPC命令前，需要先启动IPC交互式命令行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">hyperchain</span> <span class="o">-</span><span class="n">s</span> <span class="o">--</span><span class="n">ipc</span><span class="o">=</span><span class="n">hpc_1</span><span class="o">.</span><span class="n">ipc</span>
</pre></div>
</div>
<p>进入如下页面，命令行启动成功：</p>
<p><img alt="image2" src="../_images/nvp3.png" /></p>
<div class="section" id="nvp-status">
<h3>nvp status<a class="headerlink" href="#nvp-status" title="Permalink to this headline">¶</a></h3>
<p>该命令可以用于查询NVP和VP的连接状态。 <strong>VP节点上可以同时得知连接的NVP的状态和自己的状态；NVP节点只能查询到自己的状态信息</strong> 。</p>
<p>命令： <cite>nvp status &lt;namespace&gt; [hostname]</cite> （该条命令可在VP和NVP上执行）</p>
<p><strong>上述命令格式的具体含义如下所示：</strong></p>
<ul class="simple">
<li><p><cite>&lt;namespace&gt;</cite> ：必要参数，由于NVP是namespace级别的节点，因此需指定所在的namespace；</p></li>
<li><p><cite>[hostname]</cite> ：可选参数，在VP上调用时，若不指定hostname，将以列表形式返回所有与VP相连的NVP状态信息；在NVP上调用时，由于NVP只能和一个VP相连，是否指定hostname对返回结果没有影响。</p></li>
</ul>
<p>在NVP上调用 <cite>nvp status</cite> 命令，返回信息如下表所示：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>返回信息</p></th>
<th class="head"><p>含义</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>hostname</p></td>
<td><p>NVP连接的VP名称</p></td>
</tr>
<tr class="row-odd"><td><p>nvp_status</p></td>
<td><p>NVP当前的状态</p></td>
</tr>
<tr class="row-even"><td><p>height</p></td>
<td><p>NVP当前区块高度</p></td>
</tr>
</tbody>
</table>
<p>在VP上调用 <cite>nvp status</cite> 命令，返回信息如下表所示：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 86%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>返回信息</p></th>
<th class="head"><p>含义</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>hostname</p></td>
<td><p>VP连接的NVP名称</p></td>
</tr>
<tr class="row-odd"><td><p>vp_status</p></td>
<td><p>VP当前的状态</p></td>
</tr>
<tr class="row-even"><td><p>nvp_status</p></td>
<td><p>NVP当前的状态</p></td>
</tr>
<tr class="row-odd"><td><p>height</p></td>
<td><p>NVP当前区块高度</p></td>
</tr>
<tr class="row-even"><td><p>msg</p></td>
<td><p>对当前NVP的描述，这份描述内容是NVP的握手或区块事件的回复信息</p></td>
</tr>
</tbody>
</table>
<p><strong>以下是一些正常的状态指令实例：</strong></p>
<p>NVP节点查询状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nvp节点和一个vp节点相连接:格式 nvp status &lt;namespace&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">node1</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="c1"># nvp节点和一个vp节点相连接:格式 nvp status &lt;namespace&gt; [hostname]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span> <span class="n">node1</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">node1</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</pre></div>
</div>
<p>VP节点查询状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 场景：vp节点，和多个nvp节点相连接。</span>
<span class="c1"># 使用命令格式 nvp status &lt;namespace&gt; 查询</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">nvp1</span><span class="p">,</span> <span class="n">vp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NULL</span><span class="p">}</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">nvp2</span><span class="p">,</span> <span class="n">vp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NULL</span><span class="p">}</span>

<span class="c1"># 使用命令格式 nvp status &lt;namespace&gt; [hostname]查询其中一个节点信息</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span> <span class="n">nvp2</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">nvp2</span><span class="p">,</span> <span class="n">vp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NULL</span><span class="p">}</span>

<span class="c1"># 使用命令格式 nvp status &lt;namespace&gt; [hostname]查询其中一个节点信息</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span> <span class="n">nvp1</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">nvp1</span><span class="p">,</span> <span class="n">vp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NULL</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="nvp-add">
<h3>nvp add<a class="headerlink" href="#nvp-add" title="Permalink to this headline">¶</a></h3>
<p>该命令用于动态增加节点场景，VP和NVP都可以使用该指令动态增加节点。</p>
<p>命令： <cite>nvp add &lt;namespace&gt; &lt;hostname&gt; &lt;address&gt;</cite></p>
<p><strong>上述命令格式的具体含义如下所示：</strong></p>
<ul class="simple">
<li><p><cite>&lt;namespace&gt;</cite> ：必要参数，由于NVP是namespace级别的节点，因此需指定所在的namespace；</p></li>
<li><p><cite>&lt;hostname&gt;</cite> ：必要参数，指定要连接节点的名称；</p></li>
<li><p><cite>&lt;address&gt;</cite> ：必要参数，指定要连接节点的ip地址；</p></li>
</ul>
<p><strong>注意：新增命令的成功返回并不意味着连接建立成功</strong>，若在VP上执行新增命令，则可以通过先前介绍的 <cite>nvp status</cite> 命令查询NVP状态，若查询结果显示 <cite>nvp_status=NORMAL</cite> 则代表连接建立成功，而若一直处于 <cite>ABNORMAL</cite> 状态，则需要根据日志进一步排查问题；而由于NVP端无法查询VP状态，因此若在NVP上执行新增命令，是否连接成功只能通过日志来进行确认。</p>
<p><strong>NVP连接VP示例</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 初始阶段，nvp没有连接任何vp</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="n">this</span> <span class="n">nvp</span> <span class="n">connects</span> <span class="n">no</span> <span class="n">vp</span>

<span class="c1"># 正确使用add命令，连接node1，此时不代表新增node1成功</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">add</span> <span class="k">global</span> <span class="n">node1</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">50011</span>
<span class="n">success</span>

<span class="c1"># 使用状态查询，发现成功连接vp节点</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">node1</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="n">nvp</span> <span class="n">remove</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>该指令用于VP和NVP之间断开连接，VP和NVP都可以使用该指令动态删除节点。</p>
<p>ipc命令格式： <cite>nvp remove &lt;namespace&gt; &lt;hostname&gt;</cite></p>
<ul class="simple">
<li><p><cite>&lt;namespace&gt;</cite> ：必要参数，由于NVP是namespace级别的节点，因此需指定其所在的namespace；</p></li>
<li><p><cite>&lt;hostname&gt;</cite> ：必要参数，指定要连接节点的名称；</p></li>
</ul>
<p>该命令的行为如下：</p>
<ul class="simple">
<li><p>通知对端进行同样的删除操作；</p></li>
<li><p>断开网络逻辑连接；</p></li>
<li><p>删除对端配置文件信息；</p></li>
<li><p>清空相应的缓存；</p></li>
<li><p>进行证书吊销；</p></li>
</ul>
<p>该命令有如下两种返回值：</p>
<ul class="simple">
<li><p><cite>remove [hostname] success:</cite> 这意味着成功通知到对方，双方都会执行上述删除流程；</p></li>
<li><p><cite>inform [hostname] to delete failed, maybe need manual operation:</cite> 这意味着由于网络或其他节点异常问题，导致未能成功通知到对端进行删除，在这种情况下，本地仍然会执行上述删除流程， <strong>可能带来的影响是</strong> 对端的配置文件或内存中仍然保留本节点的信息，因此仍然会尝试进行连接，但由于本节点已经进行了证书吊销，连接不会建立成功， <strong>解决方法是在对端重新执行删除命令</strong> 。</p></li>
</ul>
<p><strong>VP删除NVP示例</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># vp节点查询状态，显示和多个nvp节点连接</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">nvp1</span><span class="p">,</span> <span class="n">vp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NULL</span><span class="p">}</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">nvp2</span><span class="p">,</span> <span class="n">vp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NULL</span><span class="p">}</span>

<span class="c1"># 删除其中一个NVP节点</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">remove</span> <span class="k">global</span> <span class="n">nvp1</span>
<span class="n">remove</span> <span class="p">[</span><span class="n">nvp1</span><span class="p">]</span> <span class="n">success</span>

<span class="c1"># 删除成功，查询状态</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="p">{</span><span class="n">hostname</span><span class="p">:</span> <span class="n">nvp2</span><span class="p">,</span> <span class="n">vp_status</span><span class="p">:</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">nvp_status</span><span class="p">:</span> <span class="n">NORMAL</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NULL</span><span class="p">}</span>

<span class="c1"># 删除第二个NVP节点</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">remove</span> <span class="k">global</span> <span class="n">nvp2</span>
<span class="n">remove</span> <span class="p">[</span><span class="n">nvp2</span><span class="p">]</span> <span class="n">success</span>

<span class="c1"># 删除成功，查询状态</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="n">this</span> <span class="n">vp</span> <span class="n">connects</span> <span class="n">no</span> <span class="n">nvp</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id10">
<h2>操作实例<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>这章会列举一些实际操作场景。</p>
<div class="section" id="id11">
<h3>NVP动态切换VP<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>场景：NVP通过IPC命令动态的切换VP。</p>
<p>IPC命令如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="go">{hostname: node1, nvp_status: IDLE, height: 0}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">remove</span> <span class="k">global</span> <span class="n">node1</span>
<span class="go">remove [node1] success</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="go">this nvp connects no vp</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">add</span> <span class="k">global</span> <span class="n">node2</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">50012</span>
<span class="go">add node2 success</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">status</span> <span class="k">global</span>
<span class="go">{hostname: node2, nvp_status: IDLE, height: 0}</span>
</pre></div>
</div>
<p><strong>使用过程介绍：</strong></p>
<ol class="arabic simple">
<li><p>NVP目前已经有连接的VP，通过状态查询命令可以查询到当前连接的VP节点信息；</p></li>
<li><p>NVP执行指令删除自己所连接的VP节点： <cite>nvp remove global node1</cite> ；</p></li>
<li><p>NVP节点收到返回信息 <cite>remove [node1] success</cite> 表明成功删除；</p></li>
<li><p>使用状态查询命令查询当前状态，验证已经删除成功，此时应该没有连接任何VP节点，结果应返回 <cite>this nvp connects no vp</cite> ；</p></li>
<li><p>通过add指令，添加新的想要连接的VP节点；添加新的节点之前需要根据 <strong>第二章节进行证书配置；</strong></p></li>
<li><p>如果VP节点未启动，那么需要先启动该VP节点，节点配置 <strong>参考部署文档</strong> ；</p></li>
<li><p>在NVP节点执行 <cite>nvp add global node2 127.0.0.1:50012</cite> 命令；</p></li>
<li><p>等待返回 <cite>add node2 success</cite> ，说明和node2连接的准备工作完成，但此时还不证明已经连接成功；</p></li>
<li><p>使用状态查询命令查询当前状态，验证已经添加成功，此时应该成功连接新的VP节点，结果应返回NVP的状态信息： <cite>{hostname: node2, nvp_status: IDLE, height: 0}</cite> ；</p></li>
</ol>
</div>
</div>
<div class="section" id="id12">
<h2>异常处理<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id13">
<h3>指令格式输入错误<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>命令长度/类型出现问题:</p></li>
</ul>
<blockquote>
<div><p># 命令长度不够，小于3
&gt;&gt;&gt; nvp status
Error: invalid command</p>
<p># 命令中的namespace不存在
&gt;&gt;&gt; nvp status g
Error: namespace [g] not exists</p>
<p># 命令中长度正确但是指令类型不支持，目前仅支持add、remove、status三种
&gt;&gt;&gt; nvp type global
Error: invald command</p>
</div></blockquote>
<ul class="simple">
<li><p>add指令格式有误:</p></li>
</ul>
<blockquote>
<div><p># 如namespace或者hostname的参数为空，或者输入的ip地址/端口号有问题
&gt;&gt;&gt; nvp add global   127.0.0.1:500231
Error: invalid command</p>
<p># 命令格式不正确，add命令长度必须为5，即nvp add namespace hostname addr
&gt;&gt;&gt; nvp add global
Error: invalid command: expected length: 5</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">add</span> <span class="k">global</span> <span class="n">node1</span>
<span class="go">Error: invalid command: expected length: 5</span>
</pre></div>
</div>
<p># 端口号异常
&gt;&gt;&gt; nvp add global node1 127.0.0.1：50011
Error: Uknown rune: 65306</p>
</div></blockquote>
<p><strong>解决方案：</strong> 参照 <strong>第4章节</strong> ，正确输入指令</p>
</div>
<div class="section" id="id14">
<h3>查询状态时VP与NVP并未互相连接<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>在状态查询指令之中，输入 <cite>nvp status &lt;namespace&gt; [hostname]</cite> 指令，如果查询询不到，根据节点类型返回 <cite>this vp connects no nvp/this nvp connects no vp</cite></p>
</div></blockquote>
<p><strong>解决方案：</strong> 使用添加连接命令，进行节点连接。</p>
</div>
<div class="section" id="id15">
<h3>重复添加存在节点<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如果输入指令中的hostname和现在已经启动的vp/nvp的hostname重复将会报错</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">add</span> <span class="k">global</span> <span class="n">node1</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">50023</span>
<span class="go">Error: hostname collide with existed vp</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>解决方案：</strong> 检查NVP，VP，CVP各个节点的配置文件，查看是否有重名现象，进行更改。</p>
</div>
<div class="section" id="id16">
<h3><strong>删除并不存在的节点</strong><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 删除并不存在的节点</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">remove</span> <span class="k">global</span> <span class="n">nvp2</span>
<span class="go">Error: not existed: nvp2</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>解决方案：</strong> 该节点不存在或已经删除成功，无法再进行重复操作，可以进行下一步操作，无需处理。</p>
</div>
<div class="section" id="id17">
<h3>添加节点失败<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>在添加节点之后如果出现以下情况说明添加节点失败：</p>
<p>1）如果日志信息一直在显示反复连接，出现timeout等日志信息，此时表明建立连接失败；</p>
<p>2）如果是vp节点使用状态查询的指令，如果连接的nvp节点状态一直都是 <cite>ABNORMAL</cite> 状态，也表明建立连接出现问题。</p>
<p><strong>解决方案：</strong></p>
<ul class="simple">
<li><p>此时不做处理也可以正常运行，但是后台会一直尝试连接该节点，反复打印timeout日志信息；</p></li>
<li><p>如果想要停止打印日志信息，用户可以调用remove指令撤回上一条连接add指令。</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 删除节点成功</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nvp</span> <span class="n">remove</span> <span class="k">global</span> <span class="n">node1</span>
<span class="go">remove [node1] success</span>
</pre></div>
</div>
<p># vp节点和nvp之间的连接存在问题，需要人工介入
&gt;&gt;&gt; nvp remove global nvp1
inform [nvp1] to delete failed, maybe need manual operation</p>
</div></blockquote>
<p>针对remove出错，没有成功返回success信息的场景</p>
<p><strong>解决方案：</strong> nvp和vp之间的连接状态不正常，需要根据日志信息进行人工介入。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016-2023, Hangzhou Hyperchain Technology Co., Ltd..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>